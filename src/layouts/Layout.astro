---
import { getCanonicalUrl, SITE_URL } from '../lib/site';

interface Props {
  title: string;
  description?: string;
  canonical?: string;
  ogImage?: string;
  noindex?: boolean;
}

const {
  title,
  description = "Find the best AI automation experts - Zapier, Make.com, and n8n specialists. Get quotes from top-rated agencies worldwide.",
  canonical,
  ogImage = "/og-image.png",
  noindex = false
} = Astro.props;
const pageUrl = canonical || getCanonicalUrl(Astro.url.pathname);
const turnstileSiteKey = import.meta.env.PUBLIC_TURNSTILE_SITE_KEY || '';
---

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>{title}</title>
  <meta name="description" content={description} />
  {noindex && <meta name="robots" content="noindex, nofollow" />}
  <link rel="canonical" href={pageUrl} />
  
  <!-- OpenGraph -->
  <meta property="og:title" content={title} />
  <meta property="og:description" content={description} />
  <meta property="og:url" content={pageUrl} />
  <meta property="og:type" content="website" />
  <meta property="og:image" content={getCanonicalUrl(ogImage)} />
  
  <!-- Twitter -->
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content={title} />
  <meta name="twitter:description" content={description} />
  <meta name="twitter:image" content={getCanonicalUrl(ogImage)} />
  
  <!-- JSON-LD Schema -->
  <script type="application/ld+json" set:html={JSON.stringify({
    "@context": "https://schema.org",
    "@type": "WebSite",
    "name": "AI Automation Agencies Directory",
    "description": description,
    "url": SITE_URL,
    "potentialAction": {
      "@type": "SearchAction",
      "target": `${SITE_URL}/search?q={search_term_string}`,
      "query-input": "required name=search_term_string"
    }
  })} />
  
  <link rel="icon" type="image/svg+xml" href="/favicon.svg" />

  <script type="module">
    const EVENT_ENDPOINT = '/api/events';
    const getTurnstileSiteKey = () => document.body?.dataset?.turnstileSiteKey || '';

    const makePayload = (eventType, element) => {
      if (!eventType) return null;

      const listingSlug = element?.dataset?.listingSlug || '';
      const meta = element?.dataset?.trackMeta
        ? (() => {
            try {
              return JSON.parse(element.dataset.trackMeta);
            } catch {
              return {};
            }
          })()
        : {};

      return {
        eventType,
        listingSlug,
        sourcePage: window.location.pathname + window.location.search,
        target: element?.href || element?.getAttribute?.('data-track-target') || '',
        metadata: {
          referrer: document.referrer || null,
          ...meta,
          pathname: window.location.pathname,
        },
      };
    };

    const sendEvent = async (payload) => {
      if (!payload) return;
      try {
        const body = JSON.stringify(payload);
        if (navigator.sendBeacon) {
          const blob = new Blob([body], { type: 'application/json' });
          const enqueued = navigator.sendBeacon(EVENT_ENDPOINT, blob);
          if (enqueued) return;
        }

        await fetch(EVENT_ENDPOINT, {
          method: 'POST',
          headers: { 'content-type': 'application/json' },
          body,
          keepalive: true,
        });
      } catch {
        // Event tracking should not block user experience.
      }
    };

    const fireInitialEvent = () => {
      if (!window.location.pathname.startsWith('/listing/')) return;

      const slug = window.location.pathname.replace('/listing/', '');
      void sendEvent({
        eventType: 'listing_view',
        listingSlug: slug,
        sourcePage: window.location.pathname + window.location.search,
        target: '',
        metadata: { pathname: window.location.pathname },
      });
    };

    const bootTurnstile = () => {
      const TURNSTILE_SITE_KEY = getTurnstileSiteKey();
      if (!TURNSTILE_SITE_KEY) return;

      const forms = document.querySelectorAll('form');
      const eligible = Array.from(forms).filter((form) => form.querySelector('input[name="cf-turnstile-response"]'));

      if (!eligible.length) return;

      const renderWidget = () => {
        if (!window.turnstile?.render) return;

        eligible.forEach((form) => {
          if (form.dataset.turnstileReady === '1') return;

          const tokenInput = form.querySelector('input[name="cf-turnstile-response"]');
          if (!(tokenInput instanceof HTMLInputElement)) return;

          const container = document.createElement('div');
          container.setAttribute('aria-hidden', 'true');
          container.className = 'mt-2';
          form.insertBefore(container, tokenInput.nextSibling);

          window.turnstile.render(container, {
            sitekey: TURNSTILE_SITE_KEY,
            callback: (token) => {
              tokenInput.value = token || '';
            },
            'error-callback': () => {
              tokenInput.value = '';
            },
            'timeout-callback': () => {
              tokenInput.value = '';
            },
          });

          form.dataset.turnstileReady = '1';
        });
      };

      const existingScript = document.querySelector('script[src="https://challenges.cloudflare.com/turnstile/v0/api.js"]');
      if (existingScript) {
        existingScript.addEventListener('load', renderWidget, { once: true });
        if (window.turnstile?.render) renderWidget();
        return;
      }

      const script = document.createElement('script');
      script.src = 'https://challenges.cloudflare.com/turnstile/v0/api.js';
      script.defer = true;
      script.async = true;
      script.onload = renderWidget;
      document.head.appendChild(script);
    };

    fireInitialEvent();
    if (document.body) {
      bootTurnstile();
    } else {
      window.addEventListener('DOMContentLoaded', bootTurnstile, { once: true });
    }

    document.addEventListener('click', (event) => {
      const target = event.target instanceof Element ? event.target.closest('[data-track]') : null;
      if (!target) return;
      if (
        target.closest('form[data-track-form]') ||
        (event.target instanceof HTMLButtonElement && event.target.type === 'submit')
      ) {
        return;
      }

      const payload = makePayload(target.dataset.track, target);
      if (!payload) return;

      if (target.dataset.track === 'search_submit') {
        return;
      }

      void sendEvent(payload);
    });

    document.addEventListener('submit', (event) => {
      const form = event.target instanceof Element ? event.target.closest('[data-track-form]') : null;
      if (!form) return;

      const payload = makePayload(form.dataset.trackForm, form);
      if (!payload) return;

      if (form.dataset.listing) {
        payload.listingSlug = form.dataset.listing;
      }
      void sendEvent(payload);
    });
  </script>
</head>
<body
  class="bg-slate-950 text-white min-h-screen"
  data-turnstile-site-key={turnstileSiteKey}
>
  <slot />
</body>
</html>

<style is:global>
  @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
  
  body {
    font-family: 'Inter', system-ui, sans-serif;
  }
  
  .gradient-text {
    background: linear-gradient(135deg, #22c55e 0%, #3b82f6 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
  }
  
  .card-hover {
    transition: all 0.3s ease;
  }
  
  .card-hover:hover {
    transform: translateY(-4px);
    box-shadow: 0 20px 40px -12px rgba(34, 197, 94, 0.15);
  }
</style>
