---
import Layout from '../layouts/Layout.astro';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';

const token = (Astro.url.searchParams.get('token') || '').trim();
---

<Layout title="Owner Leads - AI Automation Agencies Directory" noindex={true}>
  <Header />

  <main class="max-w-3xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
    <h1 class="text-3xl font-bold mb-4">Agency Leads</h1>
    <p class="text-slate-400 mb-8">
      Secure access page for listing owners. Use the token URL shared from admin approval.
    </p>

    {!token ? (
      <section class="bg-slate-800 border border-slate-700 rounded-2xl p-6">
        <p class="text-slate-400">Missing owner token.</p>
        <p class="text-slate-500 text-sm mt-3">
          This page requires a valid token query parameter, for example <code class="text-slate-300">/owner?token=...</code>.
        </p>
      </section>
    ) : (
      <section id="owner-page" data-token={token} class="bg-slate-800 border border-slate-700 rounded-2xl p-6">
        <p class="text-slate-500 mb-4">Loading lead data for this token...</p>
      </section>
    )}
  </main>

  <Footer />

  <script is:inline>
    (function () {
      const page = document.getElementById('owner-page');
      if (!page) return;

      const token = String(page.dataset.token || '').trim();
      if (!token) return;

      const base = `/api/owner/leads?token=${encodeURIComponent(token)}`;

      function formatDate(value) {
        if (!value) return '-';
        const d = new Date(value);
        return Number.isNaN(d.getTime()) ? value : d.toLocaleString();
      }

      fetch(base, { headers: { Accept: 'application/json' } })
        .then(async (response) => {
          const payload = await response.json().catch(() => ({}));
          if (!response.ok || !payload?.ok) {
            throw new Error(payload?.error || `Request failed (${response.status})`);
          }

          const listing = payload.listing || {};
          const leads = Array.isArray(payload.leads) ? payload.leads : [];
          const header = `
            <h2 class="text-xl font-semibold mb-2">${listing.name || listing.slug}</h2>
            <p class="text-slate-400 text-sm mb-4">
              ${listing.city || ''} ${listing.country ? `/ ${listing.country}` : ''} â€¢ ${listing.website || ''}</p>
            <p class="text-slate-300 text-sm mb-6">
              Budget range: $${Number.isFinite(listing.priceMin) ? listing.priceMin : 0} - $${
                Number.isFinite(listing.priceMax) ? listing.priceMax : 0
              }
            </p>
          `;

          if (!leads.length) {
            page.innerHTML = `${header}
              <p class="text-slate-500 text-sm">No leads yet. Keep this page available and leads will appear here.</p>`;
            return;
          }

          const rows = leads
            .map(
              (lead) => `
              <tr class="border-b border-slate-700">
                <td class="py-2 pr-3 text-sm">${lead.name || '-'}</td>
                <td class="py-2 pr-3 text-sm">${lead.email || '-'}</td>
                <td class="py-2 pr-3 text-sm">${lead.budget || '-'}</td>
                <td class="py-2 text-sm">${lead.status || 'new'}</td>
                <td class="py-2 text-sm">${formatDate(lead.created_at)}</td>
              </tr>
              <tr>
                <td colspan="5" class="py-2 pb-4 text-sm text-slate-300">${lead.message || ''}</td>
              </tr>`
            )
            .join('');

          page.innerHTML = `${header}
            <div class="overflow-x-auto">
              <table class="w-full text-left">
                <thead>
                  <tr class="text-slate-400 text-xs border-b border-slate-700">
                    <th class="py-2 pr-3">Name</th>
                    <th class="py-2 pr-3">Email</th>
                    <th class="py-2 pr-3">Budget</th>
                    <th class="py-2 pr-3">Status</th>
                    <th class="py-2">Received</th>
                  </tr>
                </thead>
                <tbody>${rows}</tbody>
              </table>
            </div>`;
        })
        .catch((error) => {
          page.innerHTML = `<p class="text-red-300">Unable to load leads: ${error.message}</p>`;
        });
    })();
  </script>
</Layout>
