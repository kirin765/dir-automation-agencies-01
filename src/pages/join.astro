---
import Layout from '../layouts/Layout.astro';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import { getCountries } from '../../scripts/process-data';

const success = Astro.url.searchParams.get('submitted') === '1';
const error = Astro.url.searchParams.get('error');

const fallbackCountries = [
  'United States',
  'United Kingdom',
  'Canada',
  'Australia',
  'Germany',
  'France',
  'Spain',
  'Italy',
  'Netherlands',
  'Sweden',
  'Switzerland',
  'Singapore',
  'United Arab Emirates',
  'India',
  'South Korea',
  'Japan',
];

const countryOptions = getCountries().map((country) => country.name);
const mergedCountries = [...new Set([...countryOptions, ...fallbackCountries].sort())];
---

<Layout title="Apply to List Your Agency - AI Automation Agencies Directory">
  <Header />

  <main class="max-w-2xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
    <h1 class="text-3xl font-bold mb-4">Apply to Join</h1>
    <p class="text-slate-400 mb-8">
      This directory shows only verified agencies. Submit your information first, and our team will review it within 48 hours.
    </p>

    <div
      id="join-feedback"
      role="status"
      aria-live="polite"
      class={`mb-4 px-4 py-3 rounded-xl border ${
        error ? 'text-red-300 border-red-500/40 bg-red-900/20' : success ? 'text-green-300 border-green-500/40 bg-green-900/20' : 'hidden'
      }`}
    >
      {error && <p>Submission failed: {error}</p>}
      {success && <p>Your application is submitted. We will review and contact you soon.</p>}
    </div>

    <form
      method="POST"
      action="/api/join-agency"
      class="space-y-6"
      data-track-form="join_form_submit"
      id="join-form"
    >
      <input type="text" name="hp" tabindex="-1" autocomplete="off" class="absolute -left-[9999px]" />
      <input type="hidden" name="cf-turnstile-response" value="" />

      <div>
        <label class="block text-sm text-slate-400 mb-2">Company Name *</label>
        <input name="companyName" required class="w-full px-4 py-3 bg-slate-800 border border-slate-700 rounded-xl text-white" />
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label class="block text-sm text-slate-400 mb-2">City *</label>
          <input name="city" required class="w-full px-4 py-3 bg-slate-800 border border-slate-700 rounded-xl text-white" />
        </div>
        <div>
          <label class="block text-sm text-slate-400 mb-2">Country *</label>
          <input
            name="country"
            required
            list="country-suggestions"
            placeholder="Type or pick a country"
            class="w-full px-4 py-3 bg-slate-800 border border-slate-700 rounded-xl text-white"
          />
          <datalist id="country-suggestions">
            {mergedCountries.map((country) => <option value={country} />)}
          </datalist>
          <p class="text-xs text-slate-500 mt-1">You can type any country name, or pick from suggestions.</p>
        </div>
      </div>

      <div>
        <label class="block text-sm text-slate-400 mb-2">Platform Focus *</label>
        <div class="text-sm text-slate-300 space-y-2">
          <label class="inline-flex items-center gap-2 mr-4">
            <input type="checkbox" value="zapier" name="platforms" />
            Zapier
          </label>
          <label class="inline-flex items-center gap-2 mr-4">
            <input type="checkbox" value="make" name="platforms" />
            Make.com
          </label>
          <label class="inline-flex items-center gap-2 mr-4">
            <input type="checkbox" value="n8n" name="platforms" />
            n8n
          </label>
          <label class="inline-flex items-center gap-2 mr-4">
            <input type="checkbox" value="custom" name="platforms" />
            Custom
          </label>
          <label class="inline-flex items-center gap-2 mr-4">
            <input type="checkbox" value="ai" name="platforms" />
            AI/LLM
          </label>
        </div>
      </div>

      <div>
        <label class="block text-sm text-slate-400 mb-2">Official Website *</label>
        <input name="website" required type="url" class="w-full px-4 py-3 bg-slate-800 border border-slate-700 rounded-xl text-white" />
      </div>

      <div>
        <label class="block text-sm text-slate-400 mb-2">Contact Name *</label>
        <input name="contactName" required class="w-full px-4 py-3 bg-slate-800 border border-slate-700 rounded-xl text-white" />
      </div>

      <div>
        <label class="block text-sm text-slate-400 mb-2">Contact Email *</label>
        <input name="contactEmail" required type="email" class="w-full px-4 py-3 bg-slate-800 border border-slate-700 rounded-xl text-white" />
      </div>

      <div>
        <label class="block text-sm text-slate-400 mb-2">Contact Phone</label>
        <input name="contactPhone" class="w-full px-4 py-3 bg-slate-800 border border-slate-700 rounded-xl text-white" />
      </div>

      <div>
        <label class="block text-sm text-slate-400 mb-2">Verification Evidence (Optional)</label>
        <input name="verificationEvidence" placeholder="Your website page link, social profile, or contract reference." class="w-full px-4 py-3 bg-slate-800 border border-slate-700 rounded-xl text-white" />
      </div>

      <div>
        <label class="block text-sm text-slate-400 mb-2">Message *</label>
        <textarea
          name="message"
          required
          rows="5"
          class="w-full px-4 py-3 bg-slate-800 border border-slate-700 rounded-xl text-white"
          placeholder="Tell us about your agency and key services."
        ></textarea>
      </div>

      <div>
        <label class="block text-sm text-slate-400 mb-2">Service Description *</label>
        <textarea
          name="description"
          required
          rows="6"
          maxlength="1200"
          class="w-full px-4 py-3 bg-slate-800 border border-slate-700 rounded-xl text-white"
          placeholder="Describe your agency, target industries, and service scope in detail."
        ></textarea>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label class="block text-sm text-slate-400 mb-2">Minimum Project Budget (USD) *</label>
          <input name="priceMin" type="number" required min="0" max="1000000" class="w-full px-4 py-3 bg-slate-800 border border-slate-700 rounded-xl text-white" />
        </div>
        <div>
          <label class="block text-sm text-slate-400 mb-2">Maximum Project Budget (USD) *</label>
          <input name="priceMax" type="number" required min="0" max="1000000" class="w-full px-4 py-3 bg-slate-800 border border-slate-700 rounded-xl text-white" />
        </div>
      </div>

      <button type="submit" class="w-full px-6 py-3 bg-green-500 hover:bg-green-600 text-black font-semibold rounded-xl">
        Submit Application
      </button>
    </form>
  </main>

  <Footer />
  <script is:inline>
    (function () {
      const form = document.getElementById('join-form');
      const feedback = document.getElementById('join-feedback');
      if (!form || !feedback) return;

      const submitButton = form.querySelector('button[type="submit"]');
      const originalText = submitButton ? submitButton.textContent : '';

      form.addEventListener('submit', async (event) => {
        event.preventDefault();

        if (submitButton) {
          submitButton.disabled = true;
          submitButton.textContent = 'Submitting...';
        }

        try {
          const response = await fetch(form.action, {
            method: 'POST',
            body: new FormData(form),
            headers: {
              Accept: 'application/json',
            },
          });

          const payload = await response.json().catch(() => ({ error: 'Unknown response format.' }));

          if (response.ok && payload?.ok) {
            feedback.className =
              'mb-4 px-4 py-3 rounded-xl border text-green-300 border-green-500/40 bg-green-900/20';
            feedback.textContent = 'Your application is submitted. We will review and contact you soon.';
            form.reset();
          } else {
            feedback.className =
              'mb-4 px-4 py-3 rounded-xl border text-red-300 border-red-500/40 bg-red-900/20';
            feedback.textContent = `Submission failed: ${payload?.error || 'Unknown error. Please try again.'}`;
            if (submitButton) submitButton.disabled = false;
            if (submitButton && originalText) submitButton.textContent = originalText;
          }
        } catch (error) {
          feedback.className =
            'mb-4 px-4 py-3 rounded-xl border text-red-300 border-red-500/40 bg-red-900/20';
          feedback.textContent = 'Submission failed. Network issue or server error. Please try again.';
          if (submitButton) {
            submitButton.disabled = false;
            submitButton.textContent = originalText || 'Submit Application';
          }
        }
      });
    })();
  </script>
</Layout>
