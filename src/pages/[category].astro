---
import Layout from '../layouts/Layout.astro';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import { getByCategory, getDirectoryCategories, getPlatformLabel, isApprovedListing } from '../../scripts/process-data';

export function getStaticPaths() {
  const categories = getDirectoryCategories();
  return categories.map(category => ({
    params: { category },
    props: { category }
  }));
}

const { category } = Astro.props;
const listings = getByCategory(category);
const categoryLabel = getPlatformLabel(category);
const pageTitle = `${categoryLabel} Experts - AI Automation Agencies`;
const pageDesc = `Find top-rated ${categoryLabel} automation experts and agencies. Browse ${listings.length} specialists worldwide.`;
const hasListings = listings.length > 0;
---

<Layout title={pageTitle} description={pageDesc} noindex={!hasListings}>
  <Header />
  
  <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
    <div class="mb-8">
      <a href="/" class="text-green-400 hover:text-green-300">‚Üê Back to Home</a>
    </div>
    
    <h1 class="text-3xl md:text-4xl font-bold mb-4">
      {categoryLabel} Experts
    </h1>
    <p class="text-slate-400 mb-8">
      {listings.length} verified automation specialists available
    </p>
    
    {hasListings ? (
      <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
        {listings.map(listing => (
          <a 
            href={`/listing/${listing.slug}`}
            data-track="listing_click"
            data-listing-slug={listing.slug}
            class="block p-6 bg-slate-800 border border-slate-700 rounded-xl card-hover"
          >
            <div class="flex items-start justify-between mb-3 gap-2">
              <h3 class="font-semibold text-lg">{listing.name}</h3>
              <div class="flex flex-wrap justify-end gap-2">
                {listing.isFeaturedActive && (
                  <span class="px-2 py-1 bg-green-500/20 text-green-400 text-xs font-medium rounded">
                    ‚òÖ Featured
                  </span>
                )}
                {isApprovedListing(listing) && (
                  <span class="px-2 py-1 bg-blue-500/20 text-blue-300 text-xs font-medium rounded">
                    Approved
                  </span>
                )}
              </div>
            </div>
            
            <div class="flex gap-2 mb-3">
              {listing.platforms.map(p => (
                <span class="px-2 py-1 bg-slate-700 text-slate-300 text-xs rounded">
                  {getPlatformLabel(p)}
                </span>
              ))}
            </div>
            
            <p class="text-slate-400 text-sm mb-4 line-clamp-2">
              {listing.description}
            </p>
            
            <div class="flex items-center justify-between text-sm">
              <span class="text-green-400">${listing.priceMin}-${listing.priceMax}</span>
              <span class="text-slate-500">üìç {listing.location}</span>
            </div>
            
            {listing.rating > 0 && (
              <div class="mt-3 text-yellow-400">
                {'‚òÖ'.repeat(Math.floor(listing.rating))}
                <span class="text-slate-500 text-sm ml-1">({listing.reviewCount})</span>
              </div>
            )}
          </a>
        ))}
      </div>
    ) : (
      <section class="bg-slate-800 border border-slate-700 rounded-2xl p-6">
        <h2 class="text-2xl font-bold mb-3">No verified listing yet in this category</h2>
        <p class="text-slate-400 mb-4">
          This section does not have verified agencies yet. If your team offers {category} automation services,
          submit a new application to get exposed.
        </p>
        <div class="flex flex-wrap gap-3">
          <a href="/join" class="px-4 py-2 bg-green-500 text-black rounded-lg font-semibold">Apply to join</a>
          <a href="/contact" class="px-4 py-2 border border-slate-600 rounded-lg hover:border-white">Talk to us</a>
        </div>
      </section>
    )}

    <section class="mt-10 bg-slate-800 border border-slate-700 rounded-2xl p-6">
      <h2 class="text-2xl font-bold mb-3">Need location-specific results?</h2>
      <p class="text-slate-400 mb-4">Narrow down by browsing location pages for this category.</p>
      <a href={`/search?platform=${category}`} class="inline-block px-4 py-2 bg-green-500 rounded-lg text-black font-semibold">
        Search by location
      </a>
    </section>
  </main>
  
  <Footer />
</Layout>
